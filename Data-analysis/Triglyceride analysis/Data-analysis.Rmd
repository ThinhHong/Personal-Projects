---
title: "Data analysis"
author: "Thinh Hong"
date: '`r Sys.Date()`'
output: html_document
---
The study involves 250 individuals and 19 variables, including the dependent variable. These variables are considered as biomarkers of cardiovascular health, which also include relevant demographic variables.
The objective of the study is to evaluate the relationship between Triglyceride (dependent variable) and the other biomarkers of cardiovascular health. The data/variable dictionary is as follows. 

1.Age in years
2. Weight
3. Height
4. Sex (male=1, female=2)
5. Body Mass Index (BMI)
6. Triglyceride (Dependent Variable)
7. Systolic Blood Pressure (SBP)
8. Diastolic Blood Pressure (DBP)
9. Hypertension Treatment (coded as HT_trt: 1=yes, 0=no)
10. Total Serum Cholesterol (coded as TSC)
11. Low-density Lipoprotein (LDL) Cholesterol (coded as LDL)
12. High-density Lipoprotein(HDL) Cholesterol (coded as HDL)
13. Cholesterol Treatment (coded as Cholesterol_Trt: yes=1, no=0)
14. Smoking (0=never, 1= used to, 2=active smoker)
15. Number of cigarettes per week (coded as Cigarettes)
16. Diabetes Status (yes=1, no=0)
17. Blood Sugar Level
18. Alcohol Intake (coded as Alcohol, and gives the number of drinks
per week)
19. Incidence of recognized and unrecognized myocardial infarction,
coronary insufficiency, and coronary heart disease (coded as Hard_CHD:
yes=1, no=0)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = FALSE, warning = FALSE}
library(SenSrivastava)
library(car)
library(ggplot2)
library(ggpubr)
library(whitestrap)
library(lmtest)
library(olsrr)
library(corrplot)
library(heatmaply)
library(gplots)
library(GGally)
library(tidyverse)
library(olsrr)
library(MASS)
setwd("~/")
```


## R Markdown

```{r }
#Read file in folder
df <- read.csv("Triglyceride.csv")
#Changes independent variables to character 
df$Sex <- as.character(df$Sex)
df$HT_Trt <- as.character(df$HT_Trt)
df$Cholesterol_Trt <- as.character(df$Cholesterol_Trt)
df$Smoking <- as.character(df$Smoking)
df$Diabetes_Status <- as.character(df$Smoking)
df$Hard.CHD <- as.character(df$Hard.CHD)

#Creating Linear Model
lm_full <- lm(Triglyceride ~ ., data= df)
summary(lm_full)
```

The amount of data points (250) indicates the data analysis test and variance are somewhat accurate
There are 6 categorical variables in the data set, Sex, Hypertension Treatment, Cholesterol Treatment, Smoking(0,1,2), Diabetes Status and Hard_CHD. A simple linear regression model was created and analyzed. Based on the p-values in the linear model, independent variables that are significant are Cholesterol, HDL
active smokers, cigarettes , Alcohol and Blood_sugar There appears to be much multicollinearity between the independent variables.

```{r warning = FALSE}

#creates plots of independent variables on Tricylecride 
avPlots(lm_full)

# Histrogram plot on density
hist(df$Triglyceride,freq = F,prob = T)
lines(density(df$Triglyceride))
```

All independent variables are then plotted against Triglyceride to determine whether or not a correlation exist. Based on the plots, variables that appear to affect Triglyceride level are Cholesterol that is increasing, HDL
decreasing, Smoking 2 decreasing, cigarettes increasing, Alcohol increasing, Blood_sugar
increasing. By viewing the histogram, It appears the highest frequency of Triglyceride is around 50-100.
Reaching its peak there and slowly lowering until 300. At which point it switches between up
and down. Therefore the data is right skewed. Indicating the data is not normally distributed.
There are also outliers when Triglyceride is around 600 .

```{r warning = FALSE}
#Creates residual , normal QQ and standardized residuals plots
par(mfrow=c(2,2))
plot(lm_full)
df$res<-residuals(lm_full)
df$res_std<-rstandard(lm_full)
qqPlot(df$res_std, envelope=list(style="lines"),col.lines="red",
id=T,pch=20,grid=F,lwd=2)
```
The first gauss-markov condition appears to be violated because of many outlines (3,43,97) in the residual plot. The assumption of constant variance is also unsatisfied since there appears to be more variance towards the middle values of Triglyceride . There is a semi straight line going through the middle of the residuals. Which verifies the linearity assumption. Based on the qq plot, we can see that the data is mostly normally distributed except for the high tail end (3,43,96). At which the residuals quickly increase. Due to the highly skewed distribution at the tail end increasing, a log based transformation is considered. The log transformation can stabilize the variance since it appears to be proportional to the square of the mean. Error terms appear to be uncorrelated as there is no discernible pattern. Based on the square root of the standardized residuals, we can see the residuals increase with Triglyceride which indicates non-constant variance. The shape of the residuals appears to be uphill in the middle. 

```{r warning = FALSE}
df_log <- read.csv("Triglyceride.csv")
df_log$Triglyceride <- log(df_log$Triglyceride)
df_log$Sex <- as.character(df$Sex)
df_log$HT_Trt <- as.character(df$HT_Trt)
df_log$Cholesterol <- as.character(df$Cholesterol)
df_log$Smoking <- as.character(df$Smoking)
df_log$Diabetes_Status <- as.character(df$Smoking)
df_log$Hard.CHD <- as.character(df$Hard.CHD)
lm_log <- lm(Triglyceride ~ ., data = df_log)
par(mfrow=c(2,2))
hist(df_log$Triglyceride,freq = F,prob = T)
lines(density(df_log$Triglyceride))
plot(lm_log)
```


After viewing the Density of the log of Triglyceride, the data appears to be more normal as the line follows a normal distribution. The E[ei] = 0 appears to be violated because of many outliers (25,3,59), therefore they maybe should be removed.  There appears to be more variance towards the middle values of Triglyceride making this condition violated. There is a semi straight line going through the middle of the residuals. Which verifies the linerality assumption. Based on the qq plot, we can see that the data is more normally distributed when compared to the orginal qq plot. As the high tail end follows a straight line more with only 1 outlier. When comapred to the orginal residual plot, residuals appear to be more spread out, follow less of a pattern and appear to have expected value of 0 and variance of simga^2.There appears to be no distinct pattern on the residuals term. Therefore, the last condition is met. Based on the With standarized residuals, it appears to mostly follow a straight line except towards the end due to an outlier. This means the residuals don't depend on the mean unlike the orginal.  the Another problem is that their appears to be co linearity. This is due to the independent variables representing similar things. For example, smoking and cigarettes are very similar. As if a person does not smoke, their cigarettes count will also be zero. Therefore we will remove the smoking variable. As well as diabetes leading to higher level blood sugar. More randonmly distributed around 0.

```{r Warning = FALSE}

```

```{r}
white_test(lm_full)
```

```{r}
dwtest(lm_log, alternative = "two.sided")

```

Since the Durbin- watson test has a value of 2.0325 and pvalue = to 0.809, there is no evidence that the true autocorrelation is not zero. Therefore generalized least squares is not neccesary. It appears weighted regression is also not needed.

```{r}
ols_plot_resid_stud_fit(lm_log)
ols_plot_cooksd_chart(lm_log)
ols_plot_dfbetas(lm_log)
ols_plot_dffits(lm_log)
ols_plot_resid_lev(lm_log)

df_log$DFBETAS<-dfbeta(lm_log)
df_log$DFFITS<-dffits(lm_log)
df_log$CookD<-cooks.distance(lm_log)
df_log$Lev<-hatvalues(lm_log)
df_log$CVR<-covratio(lm_log)
ind=1:20
par(mfrow=c(2,2))
plot(df_log$CVR,pch=1,xlab="Observations",ylab="Covariance Ratio",ylim=c(0.4,2.2))
abline(h=1,col="red",lty=2)
text(ind,df_log$CVR-0.05,labels=ind,cex=0.75)
```

There are many observations that require looking at since they are potential outliers and have an influence on estimates and predicted values (3 45,174,111,2,30,115,66,122,21,150,25,59) they have high leverage. . There are also several observations that have a significant influence on the least square estimates and predict/fitted values (59,3,5,25,34,45,97,111,122,150), 59 having the largest influece
,174,168,212,222.Those outliers also have influence on some estimates of the regression related to the independent variables. There are many values that leverages that are also outliers.  (59,34,178,169,100,58,155,8,97,15,94)
Based on the covariance plot, there are many observations that have a negative impact on the precision of the regression model, including the flag ones. These values require special attention as they may come from source of measuring error. Such as faulty measurement, analysis and others. Perhaps these errors are important information as some people are more affected by the independent variables and others. A few outliers cause the residual plot to not be completely random and have a variance sigma^2 around the 0. There should be further analysis on the outliers on experts to support deletion of outliers from data. From the covariance plot, it is showed that are many observations that have a negative impact on the regression model with values 3,5,19 have a bigger negative impact

```{r}
x <- df_log[,2:19]
rho <- cor(x)

rho2 <- cor(x)
round(rho,2)
corrplot(rho, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)

ggcorr(data = NULL, cor_matrix = rho)
corrplot(rho2,type = "upper")

ggcorr(data=NULL, cor_matrix =rho2,label = TRUE)

vif(lm_log)
solve(cor(x))

x <- as.matrix(x)

round(eigen(t(x)%*%x)$values,4)

eigen(t(x)%*%x)
colldiag(lm_log,add.intercept = F, scale=F)
```

Based on the half heat map, we can see there are many variables that are correlated. For example, it appears
sex is correlated with height and weight. This shows that the 2 value in sex indicates a lower mean in weight and height. Hdl also has a negative correlation with height and weight. It appears the following are positively correlated is slightly positively  correlated with DBP, weight and height, weight and bmi, diabeties with blood sugar, smoking and cigaretts, Hdl and sex, Cholesterol with cholesterol.

```{r}
model_in=lm(Triglyceride ~ 1,data= df_log)#initial model, with only intercept
model_s3 <- stepAIC(object=model_in,direction="both",scope = formula(lm_log))
model_s3$anova
ols_step_both_p(lm_log)

```

By comparing the regression coefficients between the full model and reduced model, we can see that 
there is only a 0.3535 - 0.331 = 0.0225 less R^2 and 0.3145-0.3031 more adjusted R^2. The akialkie's information Criterion values start at 398.7462 and lowers a decent amount until the weight is accounted for.

```{r}

```



## Including Plots
